"use client"

import type React from "react"

import { useEffect, useState } from "react"
import { useRouter } from "next/navigation"
import { Globe, ArrowUp, Copy, Download, LogOut, MessageSquare } from "lucide-react"
import { motion, useReducedMotion } from "framer-motion"
import { Bodoni_Moda } from "next/font/google"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Switch } from "@/components/ui/switch"
import { type auth, onAuth, logout } from "@/lib/firebase"
import { DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem } from "@/components/ui/dropdown-menu"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { Client, Databases } from "appwrite"
import { Progress } from "@/components/ui/progress"

// Déclaration globale pour que TypeScript reconnaisse Prettier chargé depuis le CDN
declare const prettier: any;
declare const prettierPlugins: any;

const bodoni = Bodoni_Moda({ subsets: ["latin"], display: "swap" })

type AnimationFile = {
  url: string
  content: string
  type: "css" | "js"
  isAnimation: boolean
  library?: string
  confidence: number
}

type Result = {
  title: string
  description: string
  techGuesses: string[]
  internalLinks: number
  externalLinks: number
  images: string[]
  stylesheets: number
  openGraphTags: number
  fullHTML: string
  fullCSS: string
  fullJS: string
  baseURL: string
  animationFiles: AnimationFile[]
  requiredCdnUrls: string[]
}

type ReducedResult = Omit<Result, "animationFiles" | "images">

// --- Composants UI (inchangés) ---

function CircularText({ size = 140 }: { size?: number }) {
  const prefersReduced = useReducedMotion()
  const radius = size / 2 - 8
  const text = " STUDIO • STUDIO • STUDIO • STUDIO • STUDIO • STUDIO • STUDIO • STUDIO • STUDIO • STUDIO •"
  return (
    <div className="mx-auto mb-6 flex items-center justify-center">
      <motion.svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="text-black" aria-hidden="true" animate={prefersReduced ? undefined : { rotate: 360 }} transition={prefersReduced ? undefined : { repeat: Number.POSITIVE_INFINITY, duration: 14, ease: "linear" }} style={{ willChange: "transform" }}>
        <defs>
          <path id="circlePath" d={`M ${size / 2},${size / 2} m -${radius},0 a ${radius},${radius} 0 1,1 ${radius * 2},0 a ${radius},${radius} 0 1,1 -${radius * 2},0`} />
        </defs>
        <text fill="currentColor" fontSize="12" letterSpacing="2" className={`${bodoni.className} tracking-widest`}>
          <textPath href="#circlePath">{text}</textPath>
        </text>
      </motion.svg>
    </div>
  )
}

function LogoMarquee() {
  const prefersReduced = useReducedMotion()
  const logos = ["/images/logos/windsurf-text.svg", "/images/logos/v0.svg", "/images/logos/trae-text.svg", "/images/logos/replit-text.svg", "/images/logos/cursor-text.svg"]
  const repeated = [...logos, ...logos, ...logos]
  return (
    <div className="relative my-10">
      <div className="pointer-events-none absolute inset-y-0 left-0 w-16 bg-gradient-to-r from-white to-transparent" />
      <div className="pointer-events-none absolute inset-y-0 right-0 w-16 bg-gradient-to-l from-white to-transparent" />
      <div className="overflow-hidden">
        <motion.div className="flex gap-10 items-center" animate={prefersReduced ? undefined : { x: ["0%", "-50%"] }} transition={prefersReduced ? undefined : { duration: 30, repeat: Number.POSITIVE_INFINITY, ease: "linear" }}>
          {[...repeated, ...repeated].map((src, idx) => ( <img key={`${src}-${idx}`} src={src || "/placeholder.svg"} alt="logo" className="h-6 sm:h-8 object-contain" /> ))}
        </motion.div>
      </div>
    </div>
  )
}

type FrameworkKey = "next" | "remix" | "astro" | "vite-react" | "sveltekit" | "vue-vite" | "nuxt" | "html"

const frameworkLabel: Record<FrameworkKey, string> = {
  next: "Next.js (App Router, TSX)", remix: "Remix (TSX)", astro: "Astro (.astro)", "vite-react": "Vite (React, JSX)", sveltekit: "SvelteKit (+page.svelte)", "vue-vite": "Vue (Vite, SFC)", nuxt: "Nuxt (pages/preview.vue)", html: "HTML + CSS + JS (combined)"
}

const firebaseConfig = {
    apiKey: "AIzaSyDj0G6ztVSPdX2IBxSm_OTn49uOwYGoQ60", authDomain: "gloopin-374f1.firebaseapp.com", projectId: "gloopin-374f1", storageBucket: "gloopin-374f1.firebasestorage.app", messagingSenderId: "717792072207", appId: "1:717792072207:web:a5369e110ab3daad94497a", measurementId: "G-K5GHCYGF3E",
}

// --- Composant Principal ---

export default function SiteInspector() {
  const router = useRouter()
  
  // États
  const [isAuthReady, setIsAuthReady] = useState(false)
  const [user, setUser] = useState<ReturnType<(typeof auth)["currentUser"]> | null>(null)
  const [subscription, setSubscription] = useState<any>(null)
  const [isFormatterReady, setIsFormatterReady] = useState(false)
  const [url, setUrl] = useState("")
  const [result, setResult] = useState<Result | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [copyStatus, setCopyStatus] = useState<{ id: string; message: string } | null>(null)
  const [isReducerActive, setIsReducerActive] = useState(false)
  const [reducedResult, setReducedResult] = useState<ReducedResult | null>(null)
  const [showReducedPreviewFrame, setShowReducedPreviewFrame] = useState(false)
  const [showExportModal, setShowExportModal] = useState(false)
  const [selectedFramework, setSelectedFramework] = useState<FrameworkKey>("next")
  const [generatedFilename, setGeneratedFilename] = useState<string>("")
  const [generatedCode, setGeneratedCode] = useState<string>("")
  const [showCodePreview, setShowCodePreview] = useState<boolean>(false)

  // Initialisation de Prettier (formateur de code)
  useEffect(() => {
    const scriptUrls = [
      "https://unpkg.com/prettier@2.8.8/standalone.js",
      "https://unpkg.com/prettier@2.8.8/parser-html.js",
      "https://unpkg.com/prettier@2.8.8/parser-postcss.js",
      "https://unpkg.com/prettier@2.8.8/parser-babel.js",
    ]
    let loadedScripts = 0
    const checkAllLoaded = () => {
      loadedScripts++;
      if (loadedScripts === scriptUrls.length) {
        console.log("Prettier formatter is ready.");
        setIsFormatterReady(true);
      }
    };
    scriptUrls.forEach(url => {
      const script = document.createElement("script");
      script.src = url;
      script.onload = checkAllLoaded;
      script.onerror = () => console.error(`Failed to load script: ${url}`);
      document.head.appendChild(script);
    });
  }, [])

  // Authentification
  useEffect(() => {
    const unsub = onAuth(async (u) => {
      setUser(u)
      setIsAuthReady(true)
      // La logique de souscription peut être réactivée ici si nécessaire
    })
    return () => unsub()
  }, [])

  // --- Fonctions Utilitaires ---

  const formatCode = async (code: string, parser: "html" | "css" | "babel"): Promise<string> => {
    if (!isFormatterReady || typeof prettier === 'undefined' || typeof prettierPlugins === 'undefined') {
      return code; // Retourne le code brut si Prettier n'est pas prêt
    }
    try {
      return await prettier.format(code, {
        parser: parser,
        plugins: prettierPlugins,
        htmlWhitespaceSensitivity: 'ignore', // Important pour ne pas casser la mise en page HTML
      });
    } catch (e) {
      console.error(`Prettier formatting failed for ${parser}:`, e);
      return code; // Retourne le code brut en cas d'erreur
    }
  };

  const createDownloadLink = (content: string, filename: string, mimeType: string) => {
    const blob = new Blob([content], { type: mimeType })
    const url = URL.createObjectURL(blob)
    const a = document.createElement("a")
    a.href = url
    a.download = filename
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  const copyToClipboard = async (text: string, id: string) => {
    try {
      await navigator.clipboard.writeText(text)
      setCopyStatus({ id, message: "Copié ! ✅" })
      setTimeout(() => setCopyStatus(null), 2000)
    } catch {
      setCopyStatus({ id, message: "Échec de la copie ⌐" })
    }
  }

  const fetchWithRetry = async (url: string): Promise<{ success: boolean; content: string }> => {
    try {
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
      const response = await fetch(proxyUrl)
      if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status})`)
      const data = await response.json()
      return { success: true, content: data.contents || "" }
    } catch (error) {
      console.error(`Failed to fetch ${url}:`, error)
      return { success: false, content: "" }
    }
  }

  const detectAnimationLibrary = (content: string): { isAnimation: boolean; library?: string } => {
    if (/gsap|tweenmax|tweenlite/gi.test(content)) return { isAnimation: true, library: "GSAP" }
    if (/new THREE\.|THREE\.Scene/gi.test(content)) return { isAnimation: true, library: "Three.js" }
    // Ajoutez d'autres détections ici
    return { isAnimation: false }
  }

  // --- Logique Principale ---

  const analyzeSite = async (urlToAnalyze = url) => {
    if (!urlToAnalyze) return
    setLoading(true)
    setError(null)
    setResult(null)
    setReducedResult(null)
    setShowReducedPreviewFrame(false)

    try {
      let fullUrl = urlToAnalyze;
      if (!/^https?:\/\//i.test(fullUrl)) fullUrl = "https://" + fullUrl;
      const response = await fetchWithRetry(fullUrl);
      if (!response.success) throw new Error("Could not fetch the website's main HTML.");
      
      const html = response.content;
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const baseURL = new URL(fullUrl).origin;

      const animationFiles: AnimationFile[] = [];
      
      // Extraction CSS
      const cssSources = Array.from(doc.querySelectorAll('link[rel="stylesheet"]')).map(el => new URL(el.getAttribute("href")!, baseURL).href);
      const cssFetches = await Promise.all(cssSources.map(href => fetchWithRetry(href)));
      const inlineCss = Array.from(doc.querySelectorAll("style")).map(s => s.textContent || "");
      const rawFullCSS = [...cssFetches.filter(c => c.success).map(c => c.content), ...inlineCss].join("\n\n");
      
      // Extraction JS
      const scriptSources = Array.from(doc.querySelectorAll("script[src]")).map(el => new URL(el.getAttribute("src")!, baseURL).href);
      const scriptFetches = await Promise.all(scriptSources.map(src => fetchWithRetry(src)));
      const inlineJs = Array.from(doc.querySelectorAll("script:not([src])")).map(s => s.textContent || "");
      const rawFullJS = [...scriptFetches.filter(s => s.success).map(s => s.content), ...inlineJs].join("\n\n");
      
      // Extraction HTML
      const rawFullHTML = doc.body.innerHTML;
      
      // Étape de formatage
      const fullHTML = await formatCode(rawFullHTML, 'html');
      const fullCSS = await formatCode(rawFullCSS, 'css');
      const fullJS = await formatCode(rawFullJS, 'babel');

      // Détection des animations
      scriptFetches.forEach((script, i) => {
        if(script.success) {
            const animInfo = detectAnimationLibrary(script.content);
            if (animInfo.isAnimation) {
                animationFiles.push({ url: scriptSources[i], content: script.content, type: 'js', isAnimation: true, library: animInfo.library, confidence: 80 });
            }
        }
      });

      setResult({
          title: doc.title, description: "", techGuesses: [], internalLinks: 0, externalLinks: 0,
          images: [], stylesheets: cssSources.length, openGraphTags: 0,
          fullHTML, fullCSS, fullJS,
          baseURL, animationFiles, requiredCdnUrls: []
      });

    } catch (err) {
      setError(`Analysis failed: ${err instanceof Error ? err.message : "Unknown error"}`)
    } finally {
      setLoading(false)
    }
  }
  
  const reduceHtmlAndCss = (html: string, css: string): { reducedHtml: string; reducedCss: string } => {
    // AMÉLIORATION : Utilisation de Regex pour une suppression fiable des SVGs
    const htmlWithEmojis = html.replace(/<svg[\s\S]*?<\/svg>/gi, "🎨");
    
    const parser = new DOMParser()
    const doc = parser.parseFromString(htmlWithEmojis, "text/html")
    const usedClasses = new Set<string>()
    doc.querySelectorAll("[class]").forEach((el) => el.classList.forEach((cls) => usedClasses.add(cls)))
    
    // Simplification du filtre CSS
    const cssRules = css.match(/[^\{\}]+{[^\{\}]+}/g) || [];
    const a_garder_css = cssRules.filter((rule) => {
      const selectorPart = rule.substring(0, rule.indexOf("{")).trim();
      if (!selectorPart || /^(html|body|\*|:root)/i.test(selectorPart)) return false;
      return Array.from(usedClasses).some((cls) => new RegExp(`\\.${CSS.escape(cls)}`).test(selectorPart));
    })
    
    return { reducedHtml: htmlWithEmojis, reducedCss: a_garder_css.join("\n") }
  }

  useEffect(() => {
    if (!result) return;
    const reduceCode = async () => {
      const rawAnimationJs = result.animationFiles
        .filter((file) => file.type === "js")
        .map((file) => `/* Animation script from: ${file.url} */\n${file.content}`)
        .join("\n\n");
        
      const { reducedHtml: rawReducedHtml, reducedCss: rawReducedCss } = reduceHtmlAndCss(result.fullHTML, result.fullCSS);

      // Formatage du code réduit
      const animationJs = await formatCode(rawAnimationJs, 'babel');
      const reducedHtml = await formatCode(rawReducedHtml, 'html');
      const reducedCss = await formatCode(rawReducedCss, 'css');

      setReducedResult({ ...result, fullHTML: reducedHtml, fullCSS: reducedCss, fullJS: animationJs });
    };
    reduceCode();
  }, [result]);

  const createPreviewDoc = (res: Result | ReducedResult | null) => {
      if (!res) return "";
      const { fullHTML, fullCSS, fullJS, baseURL } = res;
      return `<!DOCTYPE html><html><head><base href="${baseURL}"><style>${fullCSS}</style></head><body>${fullHTML}<script>${fullJS}</script></body></html>`;
  }

  // --- Gestionnaires d'événements ---

  const handleAnalyzeClick = () => analyzeSite()
  const handleProposalClick = (proposalUrl: string) => { setUrl(proposalUrl); analyzeSite(proposalUrl); }
  
  const buildPrompt = (source: Result | ReducedResult | null) => {
      if (!source) return "";
      return `HTML:\n\`\`\`html\n${source.fullHTML}\n\`\`\`\n\nCSS:\n\`\`\`css\n${source.fullCSS}\n\`\`\`\n\nJS:\n\`\`\`javascript\n${source.fullJS}\n\`\`\``
  }
  
  const handleCopyPrompt = () => {
      const source = isReducerActive ? reducedResult : result;
      copyToClipboard(buildPrompt(source), "prompt");
  }

  const handleDownloadPrompt = () => {
      const source = isReducerActive ? reducedResult : result;
      const prompt = buildPrompt(source);
      const filename = isReducerActive ? "prompt-reduced.txt" : "prompt-full.txt";
      createDownloadLink(prompt, filename, "text/plain");
  }

  // --- Rendu JSX ---
  const proposalUrls = ["cosmos.so", "stripe.com", "linear.app"];
  const proposalUrlImages: Record<string, string> = {
    "cosmos.so": "https://fra.cloud.appwrite.io/v1/storage/buckets/68968fe8001266b9f411/files/68969cd6000b7adb25e0/view?project=68802a5d00297352e520&mode=admin",
    "stripe.com": "https://fra.cloud.appwrite.io/v1/storage/buckets/68968fe8001266b9f411/files/68969d45000bcf13ad68/view?project=68802a5d00297352e520&mode=admin",
    "linear.app": "https://fra.cloud.appwrite.io/v1/storage/buckets/68968fe8001266b9f411/files/68969d55000989225796/view?project=68802a5d00297352e520&mode=admin",
  }

  return (
    <div className="min-h-screen bg-white overflow-hidden p-4 sm:p-8">
      <header className="max-w-4xl mx-auto flex justify-between items-center mb-12">
        <svg className="h-[20px] w-[20px]" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="#111"><rect x="0" y="0" width="32" height="32" rx="10" /></svg>
        {/* Le HeaderAction peut être ajouté ici si l'authentification est utilisée */}
      </header>

      <div className="max-w-4xl mx-auto p-6 sm:p-10 pb-60">
        <div className="text-center mb-10">
          <CircularText size={140} />
          <h1 className={`${bodoni.className} text-5xl sm:text-7xl md:text-8xl leading-[1.05] text-black mb-4`}>
            Clone your favorite website design.
          </h1>
          <p className="text-lg text-gray-600 max-w-xl mx-auto">
            Paste a URL, launch the process, and instantly get a pixel-perfect replica of any website&apos;s design.
          </p>
        </div>

        <div className="h-[45px] w-[90%] sm:w-[400px] ring-5 ring-[#eee] rounded-[12px] flex items-center p-1 mx-auto mb-4">
          <div className="h-full w-full bg-[#fff] ring-4 ring-[#FAFAFA] rounded-[12px] flex items-center p-1 ">
            <div className="p-2"><Globe size={20} className="text-black" /></div>
            <input type="text" placeholder="https://example.com" value={url} onChange={(e) => setUrl(e.target.value)} className="flex-grow h-full bg-transparent text-black focus:outline-none placeholder-[#888] text-sm" />
            <button onClick={handleAnalyzeClick} disabled={loading || !isFormatterReady} className="h-[35px] w-[35px] bg-[#111] rounded-[8px] flex items-center justify-center flex-shrink-0 disabled:opacity-50">
              {loading ? <div className="bg-white rounded-[6px] w-4 h-4 animate-pulse" /> : <ArrowUp size={20} className="text-white" />}
            </button>
          </div>
        </div>
        {!isFormatterReady && !loading && <p className="text-center text-xs text-gray-500">Initializing code formatter...</p>}

        {!loading && !result && (
          <>
            <div className="flex justify-center items-center gap-3 flex-wrap my-6">
              <span className="text-sm text-gray-500">Try:</span>
              {proposalUrls.map((pUrl) => (
                <button key={pUrl} onClick={() => handleProposalClick(pUrl)} className="h-[30px] bg-[#FAFAFA] rounded-[12px] flex items-center px-2 hover:scale-105 disabled:opacity-50" disabled={!isFormatterReady}>
                  <img src={proposalUrlImages[pUrl]} alt={`${pUrl} preview`} className="h-4 w-4 rounded-[4px] mr-2 object-cover" />
                  <p className="text-sm text-gray-700">{pUrl}</p>
                </button>
              ))}
            </div>
            <LogoMarquee />
          </>
        )}

        {error && <p className="text-red-600 bg-red-50 p-3 rounded-lg text-center mb-6">{error}</p>}

        {result && (
          <div className="space-y-12">
            <div>
              <h3 className="text-2xl font-bold text-black mb-4">Aperçu Complet</h3>
              <iframe title="UI preview" className="w-full h-96 border rounded-xl bg-white" srcDoc={createPreviewDoc(result)} sandbox="allow-scripts allow-same-origin" />
            </div>
            {reducedResult && (
              <div>
                <h3 className="text-2xl font-bold text-black mb-4">Aperçu Réduit</h3>
                <iframe title="Aperçu Réduit" className="w-full h-96 border rounded-xl bg-white" srcDoc={createPreviewDoc(reducedResult)} sandbox="allow-scripts allow-same-origin" />
              </div>
            )}
            {showReducedPreviewFrame && reducedResult && (
              <div>
                <h3 className="text-2xl font-bold text-green-600 mb-4">Test du code réduit</h3>
                <iframe title="Aperçu du Prompt Réduit Injecté" className="w-full h-96 border-2 border-green-400 rounded-xl bg-white" srcDoc={createPreviewDoc(reducedResult)} sandbox="allow-scripts allow-same-origin" />
              </div>
            )}
          </div>
        )}
      </div>

      {result && (
        <div className="fixed bottom-0 left-0 right-0 p-4 flex flex-col items-center z-50 gap-3">
          <div className="flex items-center gap-4 bg-white/80 backdrop-blur-lg p-2 rounded-2xl shadow-2xl border">
            <div className="flex items-center space-x-2 pl-2">
              <Switch id="prompt-reducer" checked={isReducerActive} onCheckedChange={setIsReducerActive} />
              <Label htmlFor="prompt-reducer" className="text-sm font-medium">Prompt Reducer</Label>
            </div>
            <Button onClick={handleCopyPrompt} className="bg-blue-600 hover:bg-blue-700 text-white">
                <Copy className="w-4 h-4 mr-2" />Copier Prompt
            </Button>
            <Button onClick={handleDownloadPrompt} variant="outline" className="border-blue-600 text-blue-600 hover:bg-blue-50 bg-white">
                <Download className="w-4 h-4 mr-2" />Télécharger Prompt
            </Button>
            <Button onClick={() => setShowReducedPreviewFrame(true)} className="bg-purple-600 hover:bg-purple-700 text-white">
                <MessageSquare className="w-4 h-4 mr-2" />Tester le rendu
            </Button>
            <Button onClick={() => setShowExportModal(true)} variant="outline" className="h-[40px] rounded-[12px] font-medium px-4 bg-white">
              <Download className="mr-2 h-4 w-4" /> Code Complet
            </Button>
          </div>

          <div className="flex items-center gap-3 bg-white/80 backdrop-blur-lg p-2 rounded-2xl shadow-lg border">
            <span className="text-sm font-medium pl-2">Télécharger Fichiers Réduits :</span>
            <Button variant="outline" size="sm" onClick={() => { if (reducedResult) createDownloadLink(reducedResult.fullHTML, 'index_reduced.html', 'text/html'); }} disabled={!reducedResult}>
                <Download className="w-4 h-4 mr-2" />HTML
            </Button>
            <Button variant="outline" size="sm" onClick={() => { if (reducedResult) createDownloadLink(reducedResult.fullCSS, 'styles_reduced.css', 'text/css'); }} disabled={!reducedResult}>
                <Download className="w-4 h-4 mr-2" />CSS
            </Button>
            <Button variant="outline" size="sm" onClick={() => { if (reducedResult) createDownloadLink(reducedResult.fullJS, 'script_reduced.js', 'application/javascript'); }} disabled={!reducedResult}>
                <Download className="w-4 h-4 mr-2" />JS
            </Button>
          </div>
        </div>
      )}

      {/* La modale d'exportation est de retour */}
      <Dialog open={showExportModal} onOpenChange={setShowExportModal}>
          <DialogContent className="sm:max-w-3xl">
          <DialogHeader>
            <DialogTitle>Export code</DialogTitle>
            <DialogDescription>Select a framework and preview the single-file export. Then download or copy it.</DialogDescription>
          </DialogHeader>
          <div className="grid gap-4">
              <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div className="space-y-2 sm:col-span-2">
                      <Label htmlFor="framework">Framework</Label>
                      <select id="framework" className="w-full h-10 rounded-md border bg-white px-3 text-sm" value={selectedFramework} onChange={(e) => setSelectedFramework(e.target.value as FrameworkKey)}>
                          {Object.entries(frameworkLabel).map(([key, label]) => (<option key={key} value={key}>{label}</option>))}
                      </select>
                  </div>
                  <div className="space-y-2">
                      <Label className="inline-flex items-center justify-between w-full"><span>View code</span><Switch checked={showCodePreview} onCheckedChange={setShowCodePreview} /></Label>
                      <input readOnly value={generatedFilename} className="w-full h-10 rounded-md border bg-gray-50 px-3 text-xs"/>
                  </div>
              </div>
              {showCodePreview && (
                  <div className="rounded-lg border bg-[#0b0c10] overflow-hidden">
                      <div className="px-3 py-2 text-xs text-gray-300 bg-[#0f1117] flex justify-between">
                          <span>{generatedFilename}</span><span className="text-gray-500">readonly preview</span>
                      </div>
                      <pre className="max-h-[420px] overflow-auto p-4 text-gray-100"><code>{generatedCode}</code></pre>
                  </div>
              )}
          </div>
          <DialogFooter className="gap-2">
              <Button variant="secondary" onClick={() => copyToClipboard(generatedCode, "export-code")} disabled={!generatedCode}><Copy className="mr-2 h-4 w-4" />Copy code</Button>
              <Button onClick={() => {if (!generatedCode || !generatedFilename) return; createDownloadLink(generatedCode, generatedFilename.replaceAll("/", "_"), "text/plain"); }} disabled={!generatedCode}>
                  <Download className="mr-2 h-4 w-4" />Download file
              </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  )
}